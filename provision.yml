---
  - name: Provision instances for security demo
    hosts: localhost
    connection: local
    gather_facts: false
    vars:
      key_name: ansibledemo
      image: ami-07128bd973a9c4e0b
      id: "ansible-security-demo"
      sec_group: "{{ id }}-sec"
    tasks:
      - name: Get Instance facts 
        block:
          - name: Get Instances facts
            community.aws.ec2_instance_info:
              aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
              aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
              region: "{{ region }}"
            register: result
  
          - name: Instance id
            debug:
              msg: "ID: {{ item.instance_id }} - State: {{ item.state.name }} - Public DNS: {{ item.public_dns_name }} \n"
            loop: "{{ result.instances }}"
  
        tags: always 
  
      - name: Provision EC2 Instances
        block:
          - name: create a VPC with dedicated tenancy and a couple of tags
            amazon.aws.ec2_vpc_net:
              name: performance_test
              cidr_block: 10.0.0.0/24
              region: "{{ region }}"
              aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
              aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
              tags:
                module: ec2_vpc_net
                app: "{{ id }}-vpn"
                environment: demo
              tenancy: dedicated
            register: vpc_net

          - name: Create internet gateway 
            community.aws.ec2_vpc_igw:
              vpc_id: "{{ vpc_net.id }}"
              region: "{{ region }}"
              state: present
              aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
              aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
              tags:
                app: "{{ id }}-vpn"
                environment: demo
            register: igw

          - name: Create subnet 
            amazon.aws.ec2_vpc_subnet:
              state: present
              region: "{{ region }}"
              vpc_id: "{{ vpc_net.id }}"
              cidr: 10.0.0.0/24
              aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
              aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
              tags:
                Name: performance_test_subnet
                app: "{{ id }}-vpn"
                environment: demo
            register: performance_test_subnet

          - name: Create security group
            amazon.aws.ec2_group:
              name: "{{ sec_group }}"
              description: Security Group for demo
              aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
              aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
              region: "{{ region }}"

          - name: Provision vpn server
            community.aws.ec2_instance:
              state: present
              aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
              aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
              key_name: ansibledemo
              name: "{{ id }}"
              security_group: default
              image_id: "{{ image }}"
              instance_type: t2.micro
              region: "{{ region }}"
              tags:
                app: "{{ id }}-vpn"
                environment: demo
            
        tags: ['never', 'provision']
  
      - name: Deprovision ec2 instance
        block:
          - name: Remove EC2 Instance 
            community.aws.ec2_instance:
              state: absent
              region: "{{ region }}"
              aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
              aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
              filters:
                tag:Environment: Testing
  
        tags: ['never', 'deprovision']